name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CI: false
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: npm install
        
      - name: Build
        run: npm run build
        env:
          CI: false
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Instalar Node.js si no est치 presente
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar PM2 globalmente si no est치 presente
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Navegar al directorio del proyecto
            cd /var/www/notion2
            
            # Actualizar el c칩digo
            git pull
            
            # Instalar dependencias y construir
            CI=false npm install
            CI=false npm run build
            
            # Reiniciar la aplicaci칩n con PM2
            pm2 describe notion2 > /dev/null
            if [ $? -eq 0 ]; then
              pm2 restart notion2
            else
              pm2 start ecosystem.config.js
            fi 